# Evolve AI Training Strategy: Hard Goldens + Soft Invariants

## üéØ Core Problem Solved

**Before**: AI training relied on 14 "golden" CSVs that were actually generated by the imperfect parser itself, creating a 100% fake success signal that taught the AI nothing.

**After**: Two-tier validation system that provides rich, actionable feedback for continuous improvement.

## üèóÔ∏è Two-Tier Validation Architecture

### Tier 1: Hard Goldens (Binary Signal)
| PDF | Status | Validation | Purpose |
|-----|--------|------------|---------|
| 2024-10 | ‚úÖ Verified | Exact diff (`diff -u`) | Binary PASS/FAIL anchor |
| 2025-05 | ‚úÖ Verified | Exact diff (`diff -u`) | Binary PASS/FAIL anchor |

**Rule**: Patches MUST keep golden pair at 100% row-match.

### Tier 2: Soft Invariants (Numeric Signal)
| Set | Count | Validation | Purpose |
|-----|-------|------------|---------|
| Candidates | 12 PDFs | Invariant suite (0-100% score) | Rich feedback for improvement |

**Rule**: Patches should increase (or maintain) invariant score.

## üìä Invariant Test Suite

### 1. Financial Accuracy Invariant
```python
def test_statement_total_matches(pdf_path, csv_path):
    """PDF total must match CSV sum within R$0.01"""
    pdf_total = extract_total_from_pdf(pdf_path)
    csv_total = sum(row['amount_brl'] for row in csv_data)
    assert abs(pdf_total - csv_total) <= Decimal("0.01")
```

### 2. Data Sanity Invariants
```python
def test_row_count_sanity(csv_data):
    """Reasonable transaction count"""
    assert 1 <= len(csv_data) <= 250

def test_no_duplicates(csv_data):
    """No duplicate transactions"""
    unique_combos = set((r['post_date'], r['desc_raw'], r['amount_brl']) 
                       for r in csv_data)
    assert len(unique_combos) == len(csv_data)
```

### 3. Coverage Invariants
```python
def test_amount_coverage(pdf_text, csv_data):
    """Every amount in PDF appears exactly once in CSV"""
    pdf_amounts = extract_all_amounts_from_text(pdf_text)
    csv_amounts = [row['amount_brl'] for row in csv_data]
    # Complex matching logic ensuring complete coverage
```

### 4. FX Balance Invariant
```python
def test_fx_transactions_balance(csv_data):
    """Foreign currency conversions must balance"""
    fx_rows = [r for r in csv_data if r['currency_orig'] != 'BRL']
    # Ensure original amounts * FX rates = BRL amounts
```

## ü§ñ AI Learning Loop Enhancement

### Current (Broken) Flow:
```
Parse ‚Üí Compare to Fake CSV ‚Üí Always 100% ‚Üí No Learning
```

### New (Smart) Flow:
```
Parse ‚Üí Golden Check (Pass/Fail) ‚Üí Invariant Score (0-100%) ‚Üí Rich Feedback
```

### Patch Acceptance Criteria:
1. **Golden Stability**: Keep 2024-10 and 2025-05 at 100% exact match
2. **Invariant Improvement**: Increase score on candidate PDFs
3. **No Regression**: Don't break existing functionality

### Example AI Feedback:
```
Golden PDFs: ‚úÖ 2/2 (100%)
Invariant Score: üìà 8.2/10 (82%) - UP from 7.8/10
  - Financial totals: ‚úÖ 11/12 PDFs
  - No duplicates: ‚úÖ 12/12 PDFs  
  - Amount coverage: ‚ùå 7/12 PDFs (NEEDS WORK)
  - FX balance: ‚úÖ 4/4 PDFs with FX

RECOMMENDATION: Focus on amount coverage patterns
```

## üîÑ CI/CD Integration

### Modified Workflow:
```yaml
- name: Parse all PDFs
  run: python scripts/parse_all.py --out csv_output

- name: Hard golden check (MUST PASS)
  run: python scripts/check_hard_goldens.py --fail-fast

- name: Invariant scoring (NUMERIC FEEDBACK)
  run: pytest tests/test_invariants.py --csv-dir csv_output --score-output invariant_score.json

- name: AI Evolution (if needed)
  if: steps.invariants.outputs.score < previous_score
  run: python .github/tools/evolve.py --target-improvement
```

## üìà Gradual Promotion Strategy

### Phase 1: Establish Baseline
1. Fix 2 hard goldens to actually work (currently broken)
2. Implement invariant test suite
3. Establish baseline scores for all candidate PDFs

### Phase 2: AI Improvement Cycles
1. Run AI patches targeting invariant improvements
2. Track score progression over time
3. Focus on worst-performing invariants

### Phase 3: Promotion to Golden Status
```bash
# After manual review of improved candidate:
cp csv_output/Itau_2024-06.csv tests/data/golden_2024-06.csv
echo "Itau_2024-06.pdf" >> config/hard_goldens.txt
sed -i '/Itau_2024-06.pdf/d' config/candidates.txt
```

## üéØ Expected Outcomes

### Immediate Benefits:
- **Clear training signal**: AI gets numeric feedback instead of fake 100%
- **Robust validation**: Properties tested, not brittle exact matches
- **Incremental improvement**: Can improve without perfect CSVs

### Long-term Success:
- **99% financial accuracy** across all PDFs
- **Automated quality assurance** for new statement formats
- **Self-improving parser** that gets better over time

## üîß Implementation Files

### New Files to Create:
- `tests/test_invariants.py` - Property-based test suite
- `scripts/parse_all.py` - Batch parsing script
- `scripts/check_hard_goldens.py` - Exact golden validation
- `config/hard_goldens.txt` - List of verified golden PDFs
- `config/candidates.txt` - List of candidate PDFs for invariant testing

### Modified Files:
- `scripts/check_accuracy.py` - Skip missing goldens instead of failing
- `.github/workflows/ci.yaml` - Integrate two-tier validation
- `.github/tools/evolve.py` - Use invariant scores for improvement targeting

## üí° Key Insights

1. **Property-based testing** is more robust than exact string matching
2. **Numeric feedback** enables gradient-based improvement
3. **Gradual promotion** maintains quality while enabling progress
4. **Financial totals** are the ultimate truth metric

This strategy transforms Evolve from a broken training loop into a sophisticated self-improving system with clear, actionable feedback mechanisms.
